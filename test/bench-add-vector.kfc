;; Vector sum

(%testspec
 (%tags bench))

(module
    (import rt)
    
  (extern time-s () -> float)

  (define (add-vectors xs ys)
    (kernel ((x xs) (y ys)) (+ x y)))
  
  (define (bench_length len)
    (let ((xs (make-vector len 1.0))
          (ys (make-vector len 1.0)))
      (println* "- vector_size: " len)
      (println* "  raw_data:")
      (println* "    total_time:")
      (for (_ 0 10)
        (let ((start (nanotime)))
          (add-vectors xs ys)
          (let ((stop (nanotime)))
            (println* "    - " (elapsed-sec start stop)))))))
    
  (define (main)
    (println* "name: harlan-dmm")
    (println* "device_type: " (match (rt-device-type)
                                ((CPU) "cpu")
                                ((GPU) "gpu")))
    (println "results:")
    ;; From 1M to 90M elements:
    (for (i 1 90 2)
      (bench_length (* i 1000000)))
    0))
